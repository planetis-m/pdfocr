name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  VERSION: ${{ github.ref_name }}

jobs:
  build-linux:
    name: Build Linux (x86_64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Nim
        uses: jiro4989/setup-nim-action@v2
        with:
          nim-version: stable
          repo-token: ${{ github.token }}

      - name: Install Atlas via Nimble
        run: nimble install -y "https://github.com/nim-lang/atlas@#head"

      - name: Install Nim dependencies
        run: atlas install

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libwebp-dev

      - name: Download PDFium
        run: |
          mkdir -p third_party/pdfium
          curl -L "https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-linux-x64.tgz" -o pdfium.tgz
          tar -xf pdfium.tgz -C third_party/pdfium

      - name: Build release binary
        run: nim c -d:release -o:pdfocr src/app.nim

      - name: Strip executable
        run: strip pdfocr

      - name: Create archive
        run: |
          mkdir -p dist
          cp pdfocr dist/
          cp third_party/pdfium/lib/libpdfium.so dist/
          cp README.md LICENSE.md dist/
          tar -czf pdfocr-linux-x86_64.tar.gz -C dist .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pdfocr-linux-x86_64-${{ env.VERSION }}
          path: pdfocr-linux-x86_64.tar.gz
          if-no-files-found: error

  build-macos:
    name: Build macOS (arm64)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Nim
        uses: jiro4989/setup-nim-action@v2
        with:
          nim-version: stable
          repo-token: ${{ github.token }}

      - name: Install Atlas via Nimble
        run: nimble install -y "https://github.com/nim-lang/atlas@#head"

      - name: Install Nim dependencies
        run: atlas install

      - name: Install build dependencies
        run: brew install curl webp

      - name: Download PDFium
        run: |
          mkdir -p third_party/pdfium
          curl -L "https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-mac-arm64.tgz" -o pdfium.tgz
          tar -xf pdfium.tgz -C third_party/pdfium

      - name: Build release binary
        run: nim c -d:release -o:pdfocr src/app.nim

      - name: Create archive
        run: |
          mkdir -p dist
          cp pdfocr dist/
          cp third_party/pdfium/lib/libpdfium.dylib dist/
          cp README.md LICENSE.md dist/
          tar -czf pdfocr-macos-arm64.tar.gz -C dist .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pdfocr-macos-arm64-${{ env.VERSION }}
          path: pdfocr-macos-arm64.tar.gz
          if-no-files-found: error

  build-windows:
    name: Build Windows (x86_64)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Nim
        uses: jiro4989/setup-nim-action@v2
        with:
          nim-version: stable
          repo-token: ${{ github.token }}

      - name: Install Atlas via Nimble
        run: nimble install -y "https://github.com/nim-lang/atlas@#head"

      - name: Install Nim dependencies
        run: atlas install

      - name: Install build dependencies
        uses: johnwason/vcpkg-action@v7
        id: vcpkg
        with:
          pkgs: curl libwebp
          triplet: x64-windows-release
          token: ${{ github.token }}

      - name: Download PDFium
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path third_party/pdfium | Out-Null
          curl.exe -L "https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-win-x64.tgz" -o pdfium.tgz
          tar -xf pdfium.tgz -C third_party/pdfium

      - name: Build release binary
        shell: pwsh
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg\installed\x64-windows-release
        run: nim c -d:release -o:pdfocr.exe src/app.nim

      - name: Create archive
        shell: pwsh
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg\installed\x64-windows-release
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item pdfocr.exe dist/
          Copy-Item third_party/pdfium/bin/pdfium.dll dist/
          Copy-Item README.md dist/
          Copy-Item LICENSE.md dist/
          Copy-Item "$env:VCPKG_ROOT\\bin\\*.dll" dist/ -ErrorAction Stop
          Compress-Archive -Path dist\* -DestinationPath pdfocr-windows-x86_64.zip -Force

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pdfocr-windows-x86_64-${{ env.VERSION }}
          path: pdfocr-windows-x86_64.zip
          if-no-files-found: error

  create-release:
    name: Create Release
    needs:
      - build-linux
      - build-macos
      - build-windows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts

      - name: Gather release files
        run: |
          mkdir -p artifacts/release
          find artifacts -type f \( -name "*.zip" -o -name "*.tar.gz" \) -exec cp {} artifacts/release/ \;
          ls -la artifacts/release/

      - name: Create release notes
        run: |
          cat > release-notes.md << EOF
          ## Release ${{ env.VERSION }}

          Prebuilt binaries for:

          - Linux x86_64: pdfocr-linux-x86_64.tar.gz
          - macOS arm64: pdfocr-macos-arm64.tar.gz
          - Windows x86_64: pdfocr-windows-x86_64.zip

          Each archive includes the pdfocr executable, PDFium runtime library, and project license/readme files.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body_path: release-notes.md
          files: artifacts/release/*
          draft: true
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Nim
        uses: jiro4989/setup-nim-action@v2
        with:
          nim-version: stable
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Dependencies
        run: sudo apt-get install -y libjpeg-dev libcurl4-openssl-dev

      - name: Download PDFium
        run: |
          mkdir -p third_party/pdfium
          curl -L https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-linux-x64.tgz -o pdfium-linux-x64.tgz
          tar -xf pdfium-linux-x64.tgz -C third_party/pdfium

      - name: Run Tests
        working-directory: tests
        run: |
          # Copy pdfium library next to exe for portability
          cp ../third_party/pdfium/lib/libpdfium.so ./
          nim test ci.nims

  macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Nim
        uses: jiro4989/setup-nim-action@v2
        with:
          nim-version: stable
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Dependencies
        run: brew install jpeg-turbo curl

      - name: Download PDFium
        run: |
          mkdir -p third_party/pdfium
          curl -L https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-mac-arm64.tgz -o pdfium-mac-arm64.tgz
          tar -xf pdfium-mac-arm64.tgz -C third_party/pdfium

      - name: Run Tests
        working-directory: tests
        run: |
          # Copy pdfium library next to exe for portability
          cp ../third_party/pdfium/lib/libpdfium.dylib ./
          nim test ci.nims

  windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Nim
        uses: jiro4989/setup-nim-action@v2
        with:
          nim-version: stable
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Dependencies
        run: choco install libjpeg-turbo curl -y

      - name: Download PDFium
        run: |
          mkdir -p third_party/pdfium
          curl -L https://github.com/bblanchon/pdfium-binaries/releases/latest/download/pdfium-win-x64.tgz -o pdfium-win-x64.tgz
          tar -xf pdfium-win-x64.tgz -C third_party/pdfium

      - name: Locate libjpeg-turbo
        shell: pwsh
        run: |
          $candidates = @(
            "C:\libjpeg-turbo64",
            "C:\ProgramData\chocolatey\lib\libjpeg-turbo\tools",
            "C:\ProgramData\chocolatey\lib\libjpeg-turbo\tools\libjpeg-turbo"
          )
          $root = $null
          foreach ($c in $candidates) {
            if (Test-Path $c) { $root = $c; break }
          }
          if (-not $root) { Write-Error "libjpeg-turbo not found"; exit 1 }
          $bin = Join-Path $root "bin"
          if (-not (Test-Path $bin)) { $bin = Join-Path $root "bin64" }
          if (-not (Test-Path $bin)) { Write-Error "libjpeg-turbo bin not found"; exit 1 }
          echo "LIBJPEG_ROOT=$root" >> $env:GITHUB_ENV
          echo "LIBJPEG_BIN=$bin" >> $env:GITHUB_ENV

      - name: Set CURL_ROOT
        shell: cmd
        run: |
          for /d %%D in (C:\ProgramData\chocolatey\lib\curl\tools\curl-*) do set CURL_ROOT=%%D
          if "%CURL_ROOT%"=="" exit /b 1
          echo CURL_ROOT=%CURL_ROOT%>> %GITHUB_ENV%

      - name: Stage DLLs
        working-directory: tests
        run: |
          Copy-Item ..\third_party\pdfium\bin\pdfium.dll .
          Copy-Item "$env:LIBJPEG_BIN\\*.dll" . -ErrorAction Stop

      - name: Run Tests
        working-directory: tests
        run: |
          $env:PATH = "$env:LIBJPEG_BIN;$env:CURL_ROOT\\bin;" + $env:PATH
          # Copy pdfium library next to exe for portability

      - name: Test jpeglib bindings
        working-directory: tests
        run: |
          $env:PATH = "$env:LIBJPEG_BIN;$env:CURL_ROOT\\bin;" + $env:PATH
          Write-Host "PATH=$env:PATH"
          Write-Host "LIBJPEG_BIN=$env:LIBJPEG_BIN"
          if (Test-Path $env:LIBJPEG_BIN) { Get-ChildItem $env:LIBJPEG_BIN } else { Write-Error "LIBJPEG_BIN path missing" }
          if (Test-Path "C:\\libjpeg-turbo64\\bin") { Get-ChildItem "C:\\libjpeg-turbo64\\bin" }
          nim c -r test_jpeglib_bindings.nim

      - name: Test jpeglib wrapper
        working-directory: tests
        run: |
          $env:PATH = "$env:LIBJPEG_BIN;$env:CURL_ROOT\\bin;" + $env:PATH
          nim c -r test_jpeglib_wrapper.nim

      - name: Test pdfium bindings
        working-directory: tests
        run: |
          $env:PATH = "$env:LIBJPEG_BIN;$env:CURL_ROOT\\bin;" + $env:PATH
          nim c -r test_pdfium_bindings.nim input.pdf

      - name: Test pdfium wrapper
        working-directory: tests
        run: |
          $env:PATH = "$env:LIBJPEG_BIN;$env:CURL_ROOT\\bin;" + $env:PATH
          nim c -r test_pdfium_wrapper.nim input.pdf

      - name: Test curl bindings
        working-directory: tests
        run: |
          $env:PATH = "$env:LIBJPEG_BIN;$env:CURL_ROOT\\bin;" + $env:PATH
          nim c -r test_curl_bindings.nim

      - name: Test curl wrapper
        working-directory: tests
        run: |
          $env:PATH = "$env:LIBJPEG_BIN;$env:CURL_ROOT\\bin;" + $env:PATH
          nim c -r test_curl_wrapper.nim
